<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Tempos Futsal APP</title>
<script src="https://cdn.tailwindcss.com"></script>

<style>
  :root{
    --azul:#1E40AF;
    --cinza:#374151;
    --verde:#16A34A;
    --vermelho:#DC2626;
    --amarelo:#FACC15;
    --bg:#f3f4f6;
  }

  body{
    background:var(--bg);
    margin:0;
    padding:12px;
    font-family:Inter,system-ui,Segoe UI,Roboto;
  }

  .app-card{
    background:white;
    padding:16px;
    border-radius:14px;
    box-shadow:0 4px 12px rgba(0,0,0,0.07);
  }

  .sticky-top{
    position:sticky;
    top:10px;
    z-index:50;
  }

  #clockCard{
    background:#111827;
    color:white;
    padding:20px;
    border-radius:14px;
    text-align:center;
  }

  #clockValue{
    font-size:6rem;
    font-weight:900;
    line-height:1;
  }

  .player-grid{
    display:grid;
    grid-template-columns:repeat(auto-fill, minmax(140px,1fr));
    gap:12px;
    margin-top:12px;
  }

  .player-btn{
    padding:12px;
    border-radius:12px;
    color:white;
    font-weight:700;
  }

  .player-court{ background:var(--verde); }
  .player-bench{ background:var(--cinza); }
  .player-out{ background:var(--vermelho); }
  .player-in{ background:var(--azul); }

  .main-btn{
    margin-top:16px;
    padding:18px;
    font-weight:900;
    font-size:1.3rem;
    border-radius:12px;
    width:100%;
    color:white;
  }

  textarea,input,select{
    width:100%;
    padding:10px;
    border-radius:10px;
    border:1px solid #d1d5db;
  }

  #logArea{
    background:white;
    border:1px solid #e5e7eb;
    height:240px;
    overflow-y:auto;
    padding:10px;
    border-radius:10px;
    font-family:monospace;
    font-size:0.9rem;
  }
</style>
</head>

<body>
<div style="max-width:1100px;margin:auto">

  <!-- Relógio -->
  <div class="sticky-top">
    <div id="clockCard">
      <div style="font-size:0.9rem;color:#d1d5db">Relógio de Jogo</div>
      <div id="clockValue">20:00</div>
    </div>
  </div>

  <!-- Painel plantel + tempo -->
  <div style="display:grid;gap:20px;margin-top:20px">

    <!-- Plantel -->
    <div class="app-card">
      <h2 style="font-weight:800;font-size:1.2rem">1. Plantel</h2>
      <div style="color:#6b7280;font-size:0.9rem">Escreve número, nome</div>

      <textarea id="playerInput" rows="7" placeholder="1, Bebé"></textarea>

      <button id="btnLoad" class="main-btn" style="background:#f59e0b;color:#111">Carregar Plantel</button>
      <div id="playersCount" style="margin-top:8px;color:#6b7280;font-size:0.9rem"></div>
    </div>

    <!-- Tempo -->
    <div class="app-card">
      <h2 style="font-weight:800;font-size:1.2rem">2. Tempo</h2>

      <div style="display:flex;gap:10px;margin-top:6px">
        <input id="minInput" type="number" value="20" />
        <input id="secInput" type="number" value="0" />
      </div>

      <select id="dirInput" style="margin-top:10px">
        <option value="down">Decrescente</option>
        <option value="up">Crescente</option>
      </select>

      <button id="btnApply" class="main-btn" style="background:#6b7280">Aplicar Tempo</button>
    </div>
  </div>

  <!-- Jogadores -->
  <div class="app-card" style="margin-top:20px">
    <h2 style="font-weight:800;font-size:1.2rem">3. Jogadores</h2>
    <div id="subInfo" style="color:#6b7280;font-size:0.9rem">Carrega o plantel</div>

    <div id="playerGrid" class="player-grid"></div>

    <!-- Iniciar relógio -->
    <button id="btnToggle" class="main-btn" style="background:var(--azul)">Iniciar Relógio</button>

    <!-- Confirmar substituição -->
    <button id="btnConfirm" class="main-btn" style="background:#2563EB;opacity:0.5" disabled>Confirmar Substituição</button>
  </div>

  <!-- Controlo -->
  <div class="app-card" style="margin-top:20px">
    <h2 style="font-weight:800;font-size:1.2rem">4. Controlo Geral</h2>

    <button id="btnStop" class="main-btn" style="background:#374151;opacity:0.5" disabled>Parar e Reiniciar</button>

    <button id="btnExport" class="main-btn" style="background:#059669">Exportar CSV</button>

    <button id="btnClear" class="main-btn" style="background:#d1d5db;color:#111">Limpar Registos</button>
  </div>

  <!-- Registos -->
  <div class="app-card" style="margin-top:20px">
    <h2 style="font-weight:800;font-size:1.2rem">5. Registo Rápido</h2>
    <div id="logArea">Sem registos</div>
  </div>

</div>

<script>
const el = id => document.getElementById(id);

/* Estado */
let players = [];
let selectedOut = null, selectedIn = null;
let totalSeconds = 1200;
let running = false;
let countingUp = false;
let tick = null;

/* Funções util */
function fmt(s){
  const m = String(Math.floor(s/60)).padStart(2,'0');
  const ss = String(s%60).padStart(2,'0');
  return m + ":" + ss;
}
function refreshClock(){
  el('clockValue').textContent = fmt(totalSeconds);
}

/* Plantel */
function loadPlantel(){
  const text = el('playerInput').value.trim();
  localStorage.setItem('plantel_futsal', text);

  players = [];
  const lines = text.split('\n');

  lines.forEach(line=>{
    const p = line.split(',');
    if(p.length < 2) return;
    const num = parseInt(p[0]);
    const name = p.slice(1).join(',').trim();
    if(!isNaN(num) && name){
      players.push({number:num,name:name,court:false});
    }
  });

  renderPlayers();
  el('playersCount').textContent = players.length + " jogadores";
}

function loadPlantelFromStorage(){
  const saved = localStorage.getItem('plantel_futsal');
  if(saved){
    el('playerInput').value = saved;
    loadPlantel();
  }
}

/* Jogadores */
function renderPlayers(){
  const grid = el('playerGrid');
  grid.innerHTML = '';
  const titulares = players.filter(p=>p.court).length;

  players.forEach(p=>{
    const b = document.createElement('button');
    let cls = 'player-btn ';
    if(p.court) cls += 'player-court';
    else cls += 'player-bench';
    if(selectedOut === p) cls = 'player-btn player-out';
    if(selectedIn === p) cls = 'player-btn player-in';

    b.className = cls;
    b.textContent = p.number + ", " + p.name;

    b.onclick = ()=>selectPlayer(p);

    grid.appendChild(b);
  });

  updateSubInfo();
}

function selectPlayer(p){
  const titulares = players.filter(x=>x.court).length;

  if(titulares < 5 && !p.court){
    p.court = true;
    renderPlayers();
    return;
  }

  if(p.court){
    selectedOut = selectedOut === p ? null : p;
  } else {
    selectedIn = selectedIn === p ? null : p;
  }

  updateSubInfo();
  renderPlayers();
}

function updateSubInfo(){
  const titulares = players.filter(p=>p.court).length;
  const ok = selectedOut && selectedIn && selectedOut !== selectedIn;

  el('btnConfirm').disabled = !ok;
  el('btnConfirm').style.opacity = ok ? '1' : '0.5';

  if(titulares < 5){
    el('subInfo').textContent = "Selecione " + (5 - titulares) + " titulares";
  } else if(ok){
    el('subInfo').textContent = "Pronto para substituir";
  } else{
    el('subInfo').textContent = "Clique num titular para sair e num suplente para entrar";
  }
}

/* Confirmar substituição */
el('btnConfirm').onclick = ()=>{
  if(!(selectedOut && selectedIn)) return;

  selectedOut.court = false;
  selectedIn.court = true;

  log("Substituição " + selectedOut.name + " → " + selectedIn.name);

  selectedOut = null;
  selectedIn = null;

  renderPlayers();
};

/* Tempo */
function applyTime(){
  const m = parseInt(el('minInput').value) || 0;
  const s = parseInt(el('secInput').value) || 0;
  countingUp = el('dirInput').value === 'up';
  totalSeconds = countingUp ? 0 : m*60+s;
  refreshClock();
}

/* Relógio */
function toggleClock(){
  if(running){ pauseClock(); return; }
  startClock();
}

function startClock(){
  if(running) return;
  running = true;

  el('btnToggle').textContent = "Pausar";
  el('btnToggle').style.background = "var(--amarelo)";
  el('btnToggle').style.color = "#111";

  clockCard.style.background = "#111827";
  clockCard.style.color = "white";

  tick = setInterval(()=>{
    if(countingUp) totalSeconds++;
    else if(totalSeconds>0) totalSeconds--;
    refreshClock();
  },1000);
}

function pauseClock(){
  running = false;
  clearInterval(tick);

  el('btnToggle').textContent = "Iniciar Relógio";
  el('btnToggle').style.background = "var(--azul)";
  el('btnToggle').style.color = "white";

  clockCard.style.background = "var(--amarelo)";
  clockCard.style.color = "#111";
}

function stopReset(){
  clearInterval(tick);
  running = false;
  applyTime();

  el('btnToggle').textContent = "Iniciar Relógio";
  el('btnToggle').style.background = "var(--azul)";
  el('btnToggle').style.color = "white";

  clockCard.style.background = "#111827";
  clockCard.style.color = "white";

  log("Reset do sistema");
}

/* Log */
function log(t){
  const area = el('logArea');
  const d = document.createElement('div');
  d.textContent = "[" + fmt(totalSeconds) + "] " + t;
  area.prepend(d);
}

function clearLog(){
  el('logArea').innerHTML = "Sem registos";
}

/* Export CSV */
function exportCSV(){
  const area = el('logArea');
  const lines = ["Tempo;Evento"];
  Array.from(area.children).reverse().forEach(div=>{
    lines.push(div.textContent.replace("] ", ";").replace("[",""));
  });

  const csv = '\uFEFF' + lines.join('\n');
  const blob = new Blob([csv],{type:"text/csv;charset=utf-8"});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = "registo.csv";
  a.click();
}

/* Botões */
el('btnLoad').onclick = loadPlantel;
el('btnApply').onclick = applyTime;
el('btnToggle').onclick = toggleClock;
el('btnStop').onclick = stopReset;
el('btnExport').onclick = exportCSV;
el('btnClear').onclick = clearLog;

/* Inicialização */
(function init(){
  applyTime();
  refreshClock();
  loadPlantelFromStorage();
})();
</script>

</body>
</html>
