<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Tempos Futsal</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body{background:#f3f4f6; font-family:Inter, sans-serif;}
.app-card{background:white; border-radius:14px; padding:20px; box-shadow:0 4px 12px rgba(0,0,0,0.08);}
.section-title{font-weight:800; margin-bottom:8px; font-size:1.2rem;}
.small-muted{color:#6b7280;}
.player-grid{display:grid; gap:12px;}
@media(min-width:600px){.player-grid{grid-template-columns:repeat(3,1fr);}}
@media(min-width:900px){.player-grid{grid-template-columns:repeat(4,1fr);}}
.player-btn{padding:14px; border-radius:10px; font-weight:700; color:white;}
.player-court{background:#16a34a;}
.player-bench{background:#374151;}
.player-out-select{background:#dc2626;}
.player-in-select{background:#2563eb;}
.control-main{padding:20px; border-radius:14px; font-size:1.4rem; font-weight:800;}
.score-big{font-size:6rem; font-weight:900; text-align:center; padding:10px 0;}
</style>
</head>

<body class="p-4">

<div class="max-w-4xl mx-auto space-y-6">

  <!-- relógio -->
  <div id="clockBox" class="app-card bg-gray-900 text-white text-center">
    <div class="small-muted text-white">Relógio de jogo</div>
    <div id="displayClock" class="score-big">20:00</div>
  </div>

  <!-- painel plantel -->
  <div class="app-card">
    <div class="section-title">1. Plantel</div>
    <div class="small-muted mb-2">Insere número, nome em cada linha</div>

    <textarea id="playerInput" rows="6" class="w-full p-2 border rounded"></textarea>

    <button id="btnLoad" class="w-full bg-yellow-600 text-white mt-3 p-3 rounded font-bold">Carregar plantel</button>
  </div>

  <!-- painel tempo -->
  <div class="app-card">
    <div class="section-title">2. Tempo</div>

    <div class="grid grid-cols-2 gap-3">
      <input id="minInput" class="p-2 border rounded text-center" value="20">
      <input id="secInput" class="p-2 border rounded text-center" value="0">
    </div>

    <select id="dirInput" class="w-full mt-3 p-2 border rounded">
      <option value="down">Decrescente</option>
      <option value="up">Crescente</option>
    </select>

    <button id="btnApplyTime" class="w-full bg-indigo-600 text-white mt-3 p-3 rounded font-bold">Aplicar tempo</button>
  </div>

  <!-- painel jogadores -->
  <div class="app-card">
    <div class="section-title">3. Jogadores</div>
    <div id="subInfo" class="small-muted mb-3">Carrega o plantel</div>

    <div id="playerGrid" class="player-grid"></div>

    <!-- botão principal iniciar -->
    <button id="btnToggle" class="control-main bg-indigo-600 text-white w-full mt-4 disabled:opacity-40">Iniciar relógio</button>

    <!-- confirmar substituição -->
    <button id="btnConfirmSub" class="w-full bg-blue-600 text-white mt-3 p-3 rounded font-bold opacity-40" disabled>Confirmar substituição</button>
  </div>

  <!-- painel parar e exportação -->
  <div class="app-card">
    <div class="section-title">Controlo geral</div>

    <button id="btnStop" class="w-full bg-gray-700 text-white p-3 rounded font-bold opacity-40" disabled>Parar e reiniciar</button>

    <button id="btnExport" class="w-full bg-emerald-600 text-white p-3 rounded font-bold mt-3">Exportar CSV</button>

    <button id="btnClear" class="w-full bg-gray-300 p-3 rounded font-bold mt-2">Limpar registos</button>
  </div>

  <!-- painel log no fim -->
  <div class="app-card">
    <div class="section-title">Registo rápido</div>
    <div id="logBox" class="p-2 h-48 overflow-auto bg-white border rounded text-sm font-mono">Sem registos</div>
  </div>

</div>

<script>
let players=[], selectedOut=null, selectedIn=null, logData=[];
let totalSeconds=1200, countingUp=false, running=false, tick=null;

const el=id=>document.getElementById(id);
const playerGrid=el('playerGrid'), logBox=el('logBox');
const displayClock=el('displayClock'), clockBox=el('clockBox');

function format(s){
  const m=String(Math.floor(s/60)).padStart(2,'0');
  const ss=String(s%60).padStart(2,'0');
  return m+":"+ss;
}

function refreshClock(){ displayClock.textContent=format(totalSeconds); }

/* carregar plantel */
function loadPlantel(){
  const txt=el('playerInput').value.trim();
  localStorage.setItem('plantel_futsal', txt);

  players=[];
  txt.split('\n').forEach(l=>{
    if(!l.includes(','))return;
    const [n,...rest]=l.split(',');
    const num=parseInt(n), name=rest.join(',').trim();
    if(!isNaN(num)&&name) players.push({number:num,name,court:false});
  });

  selectedOut=null; selectedIn=null; logData=[];
  renderPlayers();
  el('btnToggle').disabled=false;
  subInfo.textContent="Selecione 5 titulares";
}

/* mostrar jogadores */
function renderPlayers(){
  playerGrid.innerHTML="";
  players.forEach(p=>{
    const b=document.createElement('button');
    b.className="player-btn "+(p.court?"player-court":"player-bench");

    if(p===selectedOut) b.className="player-btn player-out-select";
    if(p===selectedIn) b.className="player-btn player-in-select";

    b.textContent=p.number+", "+p.name;

    b.onclick=()=>onPlayerClick(p);
    playerGrid.appendChild(b);
  });

  updateSubButtons();
}

function onPlayerClick(p){
  const inField=players.filter(x=>x.court).length;

  if(inField<5 && !p.court){
    p.court=true;
    renderPlayers();
    return;
  }

  if(p.court){
    selectedOut = selectedOut===p? null : p;
  } else {
    selectedIn = selectedIn===p? null : p;
  }

  updateSubButtons();
  renderPlayers();
}

function updateSubButtons(){
  const ready=selectedOut && selectedIn && selectedOut!==selectedIn;

  el('btnConfirmSub').disabled=!ready;
  el('btnConfirmSub').classList.toggle('opacity-40', !ready);

  const inField=players.filter(x=>x.court).length;
  subInfo.textContent=inField<5? "Selecione 5 titulares"
    : ready? "Substituição pronta"
    : "Escolha quem sai e quem entra";
}

/* confirmar substituição */
function confirmSub(){
  logData.unshift({type:"sub", time:format(totalSeconds),
    out:selectedOut.name, in:selectedIn.name, status:running?"Andar":"Parado"});

  selectedOut.court=false;
  selectedIn.court=true;
  selectedOut=null; selectedIn=null;

  renderPlayers();
  refreshLog();
}

/* relógio */
function startClock(){
  running=true;
  el('btnToggle').textContent="Pausar";
  el('btnToggle').classList.remove("bg-indigo-600");
  el('btnToggle').classList.add("bg-yellow-400");

  clockBox.classList.remove("bg-yellow-300");
  clockBox.classList.add("bg-gray-900");

  el('btnStop').disabled=false;
  el('btnStop').classList.remove("opacity-40");

  tick=setInterval(()=>{
    if(countingUp) totalSeconds++;
    else if(totalSeconds>0) totalSeconds--;
    refreshClock();
  },1000);
}

function pauseClock(){
  running=false;
  clearInterval(tick);

  el('btnToggle').textContent="Retomar";
  el('btnToggle').classList.remove("bg-yellow-400");
  el('btnToggle').classList.add("bg-indigo-600");

  clockBox.classList.remove("bg-gray-900");
  clockBox.classList.add("bg-yellow-300");
}

function toggleClock(){ running?pauseClock():startClock(); }

function stopAndReset(){
  running=false;
  clearInterval(tick);

  const m=parseInt(el('minInput').value)||0;
  const s=parseInt(el('secInput').value)||0;

  totalSeconds = el('dirInput').value==="up"?0:(m*60+s);
  countingUp = el('dirInput').value==="up";

  refreshClock();

  el('btnToggle').textContent="Iniciar relógio";
  el('btnToggle').classList.remove("bg-yellow-400");
  el('btnToggle').classList.add("bg-indigo-600");

  el('btnStop').disabled=true;
  el('btnStop').classList.add("opacity-40");

  clockBox.classList.remove("bg-yellow-300");
  clockBox.classList.add("bg-gray-900");
}

/* log */
function refreshLog(){
  if(logData.length===0){ logBox.textContent="Sem registos"; return; }
  logBox.innerHTML="";
  logData.forEach(l=>{
    const d=document.createElement("div");
    d.textContent=`[${l.time}] ${l.type==="sub"?"Sub":"Info"} ${l.out? "Sai "+l.out+", entra "+l.in:""}`;
    logBox.appendChild(d);
  });
}

/* exportação */
function exportCSV(){
  const lines=["Tempo;Evento;Detalhes"];
  logData.slice().reverse().forEach(l=>{
    if(l.type==="sub") lines.push(`${l.time};Substituição;Sai ${l.out}, Entra ${l.in}`);
  });

  const blob=new Blob(["\uFEFF"+lines.join("\n")],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="registo_futsal.csv";
  a.click();
}

/* eventos */
el('btnLoad').onclick=loadPlantel;
el('btnConfirmSub').onclick=confirmSub;
el('btnToggle').onclick=toggleClock;
el('btnStop').onclick=stopAndReset;
el('btnApplyTime').onclick=stopAndReset;
el('btnExport').onclick=exportCSV;
el('btnClear').onclick=()=>{logData=[];refreshLog();};

/* arrancar */
(function init(){
  const saved=localStorage.getItem("plantel_futsal");
  if(saved){ el('playerInput').value=saved; loadPlantel(); }
  refreshClock();
})();
</script>

</body>
</html>
